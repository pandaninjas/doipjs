---
kind: pipeline
name: release-stable-version

steps:
  - name: build stable proxy container
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      dockerfile: docker/proxy/Dockerfile
      repo: keyoxide/doip-proxy
      tags: stable
  - name: build tag proxy container
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      dockerfile: docker/proxy/Dockerfile
      repo: keyoxide/doip-proxy
      auto_tag: true
  - name: publish on npm
    image: plugins/npm
    settings:
      username: yarmo_eu
      password:
        from_secret: npm_password
      email:
        from_secret: npm_email

trigger:
  event:
    - tag

---
kind: pipeline
name: release-dev-version

steps:
  - name: run tests
    image: node
    commands:
    - yarn
    - yarn run prepare
    - yarn run test
  - name: build dev proxy container
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      dockerfile: docker/proxy/Dockerfile
      repo: keyoxide/doip-proxy
      tags: dev

trigger:
  branch:
    - main
  event:
    - push
